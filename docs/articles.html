<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« åˆ—è¡¨ - mstouk57gã®å°ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="text-white min-h-screen flex flex-col items-center justify-start overflow-hidden">
    <!-- èƒŒæ™¯ -->
    <div id="background-container" class="fixed inset-0 z-0 bg-cover bg-center bg-no-repeat"></div>
    <div id="overlay" class="fixed inset-0 z-10"></div>

    <main class="relative z-20 w-full max-w-6xl px-4 py-8 fade-in">
        <!-- è¿”å›é¦–é¡µ -->
        <div class="mb-8">
            <a href="/" class="inline-flex items-center glass-card px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                <i class="fas fa-arrow-left mr-2"></i> è¿”å›é¦–é¡µ
            </a>
        </div>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">æŠ€æœ¯æ–‡ç« </h1>
            <p class="text-xl opacity-90" id="articles-count">æ­£åœ¨åŠ è½½æ–‡ç« ...</p>
        </div>

        <!-- æ’åºç­›é€‰ -->
        <div class="glass-card rounded-xl p-4 mb-8 flex flex-wrap gap-4 justify-center">
            <button onclick="sortBy('date')" id="sort-date" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 transition">
                <i class="fas fa-calendar-alt mr-2"></i>æœ€æ–°
            </button>
            <button onclick="sortBy('name')" id="sort-name" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                <i class="fas fa-sort-alpha-down mr-2"></i>åç§°
            </button>
            <button onclick="sortBy('words')" id="sort-words" class="px-4 py-2 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                <i class="fas fa-file-word mr-2"></i>å­—æ•°
            </button>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div id="articles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            <div class="text-center py-12 col-span-full">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mx-auto mb-4"></div>
                <p>æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨...</p>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="stats-container" class="glass-card rounded-2xl p-6 text-center mb-8">
            <div class="flex flex-wrap justify-center gap-8">
                <div>
                    <div class="text-3xl font-bold" id="total-articles">0</div>
                    <div class="text-sm opacity-80">æ–‡ç« æ€»æ•°</div>
                </div>
                <div>
                    <div class="text-3xl font-bold" id="total-words">0</div>
                    <div class="text-sm opacity-80">æ€»å­—æ•°</div>
                </div>
                <div>
                    <div class="text-3xl font-bold" id="latest-article">--</div>
                    <div class="text-sm opacity-80">æœ€è¿‘æ›´æ–°</div>
                </div>
            </div>
        </div>

        <!-- æ›´æ–°ä¿¡æ¯ -->
        <div class="text-center text-sm opacity-70 mb-8">
            <p id="last-updated">ç´¢å¼•æœ€åæ›´æ–°äºï¼š--</p>
        </div>

        <!-- ç‰ˆæƒä¿¡æ¯ -->
        <div class="text-center text-sm opacity-70 mt-8">
            <p>Â© <span id="current-year"></span> ntcho & ConiMite â€¢ mstouk57g</p>
        </div>
    </main>

    <script>
        let articles = [];
        let currentSort = 'date';

        // è®¾ç½®å½“å‰å¹´ä»½
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // åŠ è½½èƒŒæ™¯
        async function loadBackground() {
            try {
                const response = await fetch('https://www.loliapi.com/acg/pc/?type=json');
                const data = await response.json();
                document.getElementById('background-container').style.backgroundImage = `url('${data.url}')`;
                document.getElementById('overlay').style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            } catch (error) {
                document.getElementById('background-container').style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('overlay').style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            }
        }

        // åŠ è½½æ–‡ç« ç´¢å¼•
        async function loadArticlesIndex() {
            try {
                const response = await fetch('articles-list.json');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                articles = await response.json();

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                const fileResponse = await fetch('articles-list.json', { method: 'HEAD' });
                if (fileResponse.ok) {
                    const lastModified = fileResponse.headers.get('last-modified');
                    if (lastModified) {
                        const date = new Date(lastModified);
                        document.getElementById('last-updated').textContent =
                            `ç´¢å¼•æœ€åæ›´æ–°äºï¼š${date.toLocaleString('zh-CN')}`;
                    }
                }

                // æ¸²æŸ“æ–‡ç« 
                renderArticles();
                updateStats();

            } catch (error) {
                console.error('åŠ è½½æ–‡ç« ç´¢å¼•å¤±è´¥:', error);
                showError('æ— æ³•åŠ è½½æ–‡ç« åˆ—è¡¨ï¼Œè¯·ç¡®ä¿ articles-list.json æ–‡ä»¶å­˜åœ¨ã€‚');
            }
        }

        // æ¸²æŸ“æ–‡ç« 
        function renderArticles() {
            const container = document.getElementById('articles-container');

            if (articles.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-5xl mb-4">ğŸ“</div>
                        <h3 class="text-xl font-bold mb-2">æš‚æ— æ–‡ç« </h3>
                        <p class="opacity-80 mb-4">è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•æ–‡ç« </p>
                        <div class="inline-block glass-card p-4 rounded-lg max-w-md mx-auto">
                            <p class="text-sm mb-2">ä½¿ç”¨æ–¹æ³•ï¼š</p>
                            <ol class="text-left text-sm opacity-80 list-decimal pl-5">
                                <li class="mb-1">åœ¨ <code class="bg-black bg-opacity-30 px-1 py-0.5 rounded">articles/</code> ç›®å½•ä¸‹åˆ›å»º .md æ–‡ä»¶</li>
                                <li class="mb-1">GitHub Action ä¼šè‡ªåŠ¨ç”Ÿæˆç´¢å¼•</li>
                                <li>æ–‡ä»¶ä¼šè‡ªåŠ¨å‡ºç°åœ¨è¿™é‡Œ</li>
                            </ol>
                        </div>
                    </div>
                `;
                return;
            }

            // æ’åºæ–‡ç« 
            let sortedArticles = [...articles];
            switch(currentSort) {
                case 'name':
                    sortedArticles.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'words':
                    sortedArticles.sort((a, b) => b.wordCount - a.wordCount);
                    break;
                case 'date':
                default:
                    // é»˜è®¤æŒ‰æ—¶é—´å€’åº
                    sortedArticles.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
                    break;
            }

            // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€
            updateSortButtons();

            // æ›´æ–°æ–‡ç« è®¡æ•°
            document.getElementById('articles-count').textContent = `å…± ${sortedArticles.length} ç¯‡æ–‡ç« `;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // æ¸²æŸ“æ–‡ç« å¡ç‰‡
            sortedArticles.forEach(article => {
                const card = createArticleCard(article);
                container.appendChild(card);
            });
        }

        // åˆ›å»ºæ–‡ç« å¡ç‰‡
        function createArticleCard(article) {
            const card = document.createElement('div');
            card.className = 'article-card glass-card rounded-2xl p-6 cursor-pointer h-full flex flex-col';
            card.onclick = () => {
                window.location.href = `article.html?name=${encodeURIComponent(article.filename)}`;
            };

            // æ ¼å¼åŒ–æ—¥æœŸ
            const date = new Date(article.lastModified);
            const formattedDate = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // ç›¸å¯¹æ—¶é—´
            const relativeTime = getRelativeTime(date);

            card.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-2xl text-purple-300">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <span class="text-xs opacity-70 bg-black bg-opacity-30 px-2 py-1 rounded" title="${date.toLocaleString('zh-CN')}">
                            ${relativeTime}
                        </span>
                    </div>

                    <h3 class="text-xl font-bold mb-3 line-clamp-2">${article.title}</h3>
                    <p class="text-sm opacity-80 mb-4 line-clamp-3 flex-1">${article.description || 'æš‚æ— æè¿°'}</p>
                </div>

                <div class="border-t border-white border-opacity-20 pt-4 mt-4">
                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center" title="ä½œè€…">
                            <i class="fas fa-user-circle mr-1 opacity-70"></i>
                            <span class="opacity-80">${article.author}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center" title="å­—æ•°">
                                <i class="fas fa-file-word mr-1 opacity-70"></i>
                                <span class="opacity-80">${article.wordCount}</span>
                            </div>
                            <div class="flex items-center" title="æäº¤æ¬¡æ•°">
                                <i class="fas fa-code-commit mr-1 opacity-70"></i>
                                <span class="opacity-80">${article.commitCount}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // è·å–ç›¸å¯¹æ—¶é—´
        function getRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 60) {
                return `${diffMins}åˆ†é’Ÿå‰`;
            } else if (diffHours < 24) {
                return `${diffHours}å°æ—¶å‰`;
            } else if (diffDays < 30) {
                return `${diffDays}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (articles.length === 0) {
                document.getElementById('stats-container').classList.add('hidden');
                return;
            }

            document.getElementById('stats-container').classList.remove('hidden');

            const totalArticles = articles.length;
            const totalWords = articles.reduce((sum, article) => sum + (article.wordCount || 0), 0);

            // æ‰¾åˆ°æœ€æ–°æ–‡ç« 
            const latestArticle = articles.reduce((latest, current) =>
                new Date(current.lastModified) > new Date(latest.lastModified) ? current : latest
            );

            const latestDate = new Date(latestArticle.lastModified);
            const formattedLatestDate = latestDate.toLocaleDateString('zh-CN', {
                month: 'long',
                day: 'numeric'
            });

            document.getElementById('total-articles').textContent = totalArticles;
            document.getElementById('total-words').textContent = totalWords.toLocaleString();
            document.getElementById('latest-article').textContent = formattedLatestDate;
        }

        // æ’åºå‡½æ•°
        function sortBy(type) {
            currentSort = type;
            renderArticles();
        }

        // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€
        function updateSortButtons() {
            const buttons = ['date', 'name', 'words'];
            buttons.forEach(type => {
                const button = document.getElementById(`sort-${type}`);
                if (button) {
                    if (type === currentSort) {
                        button.classList.add('bg-purple-600', 'hover:bg-purple-700');
                        button.classList.remove('hover:bg-white', 'hover:bg-opacity-10');
                    } else {
                        button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                        button.classList.add('hover:bg-white', 'hover:bg-opacity-10');
                    }
                }
            });
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const container = document.getElementById('articles-container');
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="text-4xl mb-4">âŒ</div>
                    <h3 class="text-xl font-bold mb-2">åŠ è½½å¤±è´¥</h3>
                    <p class="opacity-80 mb-4">${message}</p>
                    <div class="space-x-4">
                        <button onclick="location.reload()" class="glass-card px-6 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition">
                            <i class="fas fa-redo mr-2"></i> é‡æ–°åŠ è½½
                        </button>
                        <a href="https://github.com/mstouk57g/mstouk57g.github.io/actions" target="_blank" class="glass-card px-6 py-3 rounded-lg hover:bg-white hover:bg-opacity-10 transition inline-block">
                            <i class="fab fa-github mr-2"></i> æŸ¥çœ‹ Actions
                        </a>
                    </div>
                </div>
            `;
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', () => {
            loadBackground();
            loadArticlesIndex();
        });
    </script>
</body>
</html>